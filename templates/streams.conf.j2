####################################################
#                                                  #
#          A N S I B L E   T E M P L A T E         #
#                                                  #
####################################################

stream {


    map_hash_bucket_size 64;
    map $ssl_preread_server_name $name {
{% for stream in item.streams %}
        {{ stream.domain | default('default') }} {{ stream.name | default('default') }}_backend;
{% endfor %}
    }

{% for stream in item.streams %}
{% if item.streams | length > 1 %}
    upstream {{ stream.name | default('default') }}_backend {
{% for ip in stream.upstream_ip %}
        server {{ ip }}:{{ stream.upstream_port }};
{% endfor %}
    }
{% else %}
    upstream backend {
{% for ip in stream.upstream_ip %}
        server {{ ip }}:{{ stream.upstream_port }};
{% endfor %}
    }
{% endif %}
{% endfor %}

    server {
        listen {{ item.listen_port | default('443') }};
        listen [::]:{{ item.listen_port | default('443') }};

{% if item.streams | length > 1 %}
        # since 1.11.5
        ssl_preread on;
        proxy_pass $name;
{% else %}
        proxy_pass backend;
{% endif %}

        # Increase buffer to serve video
        proxy_buffer_size 10m;
    }
}
